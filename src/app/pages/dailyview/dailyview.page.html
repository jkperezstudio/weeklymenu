<ion-header [translucent]="true">
    <ion-toolbar>
        <ion-buttons slot="start">
            <ion-menu-button></ion-menu-button>
        </ion-buttons>
        <img class="icon-upper-bar" src="assets/sidebaricons/day.png" slot="start" width="32" height="32" />
        <ion-title>Daily View</ion-title>
    </ion-toolbar>
</ion-header>

<ion-content>
    <!-- Contenedor principal -->
    <div class="main-content">
        <!-- Tarjeta de comidas -->
        <ion-card #mealCard class="todaysmealcontent">

            <!-- Área de gesto (SOLO aquí funciona el swipe para cambiar día) -->
            <div class="swipe-header">
                <ion-card-header>
                    <ion-card-title class="todaysmealstittle">Today's Meals</ion-card-title>
                    <h3 class="todaysdate">{{ formattedDate }}</h3>
                </ion-card-header>
            </div>

            <!-- Lista de comidas (área independiente con scroll) -->
            <ion-card-content class="meals-content">
                <div *ngFor="let meal of meals">
                    <ion-item-sliding *ngIf="meal && meal.name; else emptyMeal">
                        <ion-item lines="none">
                            <ion-checkbox slot="end" aria-label="CheckBox" [checked]="meal.done"
                                (ionChange)="toggleMealDone(meal)" [ngClass]="getColorClass(meal)">
                            </ion-checkbox>

                            <ion-label (click)="openMealForm(meal)" [ngClass]="{'meal-done': meal.done}">
                                <h1 class="mealtype">{{ meal.mealtype}}</h1>
                                <h2 class="meal">{{ meal.name }}</h2>
                                <p *ngIf="meal.description">{{ meal.description }}</p>
                            </ion-label>
                        </ion-item>
                        <ion-item-options side="end">
                            <ion-item-option color="danger" (click)="clearMealContent(meal)">
                                Clear
                            </ion-item-option>
                        </ion-item-options>
                    </ion-item-sliding>

                    <ng-template #emptyMeal>
                        <ion-item (click)="openMealForm(meal)">
                            <ion-label>
                                <h1 class="mealtype">{{ meal.mealtype}}</h1>
                                <h2 class="notmealyet">Add Meal</h2>
                            </ion-label>
                        </ion-item>
                    </ng-template>
                </div>
            </ion-card-content>
            <div class="swipe-footer">

                <!--
                <ion-icon name="arrow-back"></ion-icon>
                Swipe to change day
                <ion-icon name="arrow-forward"></ion-icon>
                -->
                :: SWIPE AREA ::
                <!-- FAB dentro del footer 
                <ion-fab vertical="bottom" horizontal="end" class="footer-fab">
                    <ion-fab-button class="add-meal-fab">
                        <ion-icon name="add"></ion-icon>
                    </ion-fab-button>
                </ion-fab>-->


                <!-- <ion-button class="button-trapezoid">Click Me</ion-button>-->
            </div>
        </ion-card>

        <!-- Botones fijos en la parte inferior -->
        <div class="buttons-container">
            <ion-button expand="block" (click)="finalizeDay()" [disabled]="!isDayComplete()"
                [color]="isDayComplete() ? 'primary' : 'medium'">
                Finalize Day</ion-button>

            <div class="navigation-buttons">
                <ion-button (click)="navigateToDate(goToPreviousDay())">Previous</ion-button>
                <ion-button (click)="navigateToDate(goToNextDay())">Next</ion-button>
            </div>
        </div>
    </div>

    <!-- Modal para añadir/editar comidas -->
    <ion-modal #mealModal [isOpen]="isModalOpen" (didDismiss)="onModalDismiss($event)">
        <ng-template>
            <ion-header>
                <ion-toolbar>
                    <ion-title>{{ currentMeal.name ? 'Edit Meal' : 'Add Meal' }}</ion-title>
                </ion-toolbar>
            </ion-header>

            <ion-content class="modal-container">

                <ion-item fill="outline" lines="none">
                    <ion-input class="name" label="Name" placeholder="Enter meal name" labelPlacement="floating"
                        fill="outline" required [(ngModel)]="currentMeal.name" (ionInput)="filterSuggestions()">
                    </ion-input>
                </ion-item>

                <!-- Lista de sugerencias -->
                <ion-list lines="none" *ngIf="suggestions.length > 0" class="suggestion-list">
                    <ion-item button *ngFor="let suggestion of suggestions" (click)="selectSuggestion(suggestion)">
                        {{ suggestion.name }}
                    </ion-item>
                </ion-list>

                <ion-item class="score" lines="none">
                    <ion-label>Score</ion-label>
                    <ion-range min="1" max="5" step="1" snaps="true" ticks="true" [(ngModel)]="currentMeal.score"
                        [ngStyle]="{'--knob-background': getColorByScore(currentMeal.score)}">
                    </ion-range>
                </ion-item>


                <ion-item lines="none">
                    <ion-label>Alarma Descongelación</ion-label>
                    <ion-toggle [checked]="currentMeal.defrostAlarm?.enabled || false"
                        (ionChange)="handleDefrostToggle($event)"></ion-toggle>
                </ion-item>

                <!-- Corrección de la interpolación -->
                <div *ngIf="currentMeal.defrostAlarm?.enabled">
                    <ion-item lines="none">
                        <ion-label>Hora Alarma</ion-label>
                        <ion-button (click)="openTimePicker()">
                            {{ (currentMeal.defrostAlarm?.scheduledTime | date:'shortTime') || 'Seleccionar' }}
                        </ion-button>
                    </ion-item>
                </div>

                <ion-popover [isOpen]="isTimePickerOpen">
                    <ion-content>
                        <ion-datetime presentation="time" [showDefaultButtons]="true"
                            (ionChange)="onTimeSelected($event)" (ionCancel)="onTimePickerCancel()"></ion-datetime>
                    </ion-content>
                </ion-popover>

                <ion-item class="delivery" lines="none">
                    <ion-label>Delivery?</ion-label>
                    <ion-toggle aria-label="Delivery Toggle" slot="end" [(ngModel)]="currentMeal.delivery">
                    </ion-toggle>
                </ion-item>

                <ion-button class="savebutton" (click)="saveMeal()"
                    [disabled]="!currentMeal.name || !currentMeal.score">
                    SAVE
                </ion-button>
            </ion-content>
        </ng-template>
    </ion-modal>

</ion-content>