<ion-content>
    <!-- Contenedor principal -->
    <div class="main-content">
        <!-- Tarjeta de comidas -->
        <ion-card #mealCard class="todaysmealcontent">

            <ion-card-header>
                <ion-card-title class="todaysmealstittle">Today's Meals</ion-card-title>
                <h3 class="todaysdate">{{ formattedDate }}</h3>
                <!-- FAB dentro del header -->
                <ion-fab vertical="bottom" horizontal="end" class="footer-fab">
                    <ion-fab-button>
                        <ion-icon name="add"></ion-icon>
                    </ion-fab-button>
                </ion-fab>
            </ion-card-header>

            <!-- Lista de comidas (área independiente con scroll) -->
            <ion-card-content class="meals-content">
                <div *ngFor="let meal of meals">
                    <ion-item-sliding *ngIf="meal && meal.name; else emptyMeal">
                        <ion-item class="mealReady" lines="none">
                            <ion-checkbox aria-label="Meal Done Checkbox" slot="end" [checked]="meal.done"
                                (ionChange)="toggleMealDone(meal)" [ngClass]="getColorClass(meal)">
                            </ion-checkbox>

                            <ion-label (click)="openMealForm(meal)" [ngClass]="{'meal-done': meal.done}">
                                <h1 class="mealtype">{{ meal.mealtype }}</h1>
                                <h2 class="meal">{{ meal.name }}</h2>
                                <p *ngIf="meal.description">{{ meal.description }}</p>
                            </ion-label>

                        </ion-item>
                        <ion-item-options side="end">
                            <ion-item-option (click)="clearMealContent(meal)">
                                <ion-icon name="trash"></ion-icon>
                            </ion-item-option>
                        </ion-item-options>
                    </ion-item-sliding>

                    <ng-template #emptyMeal>
                        <ion-item class="mealReady" lines="none" (click)="openMealForm(meal)">
                            <ion-label>
                                <h1 class="mealtype">{{ meal.mealtype}}</h1>
                                <h2 class="notmealyet">Add Meal</h2>
                            </ion-label>
                        </ion-item>
                    </ng-template>
                </div>
            </ion-card-content>

            <div class="swipe-footer">
                <!-- Botones SIN la clase navigation-buttons -->
                <ion-button (click)="navigateToDate(goToPreviousDay())">
                    <ion-icon name="arrow-back"></ion-icon>
                </ion-button>

                <ion-button (click)="navigateToDate(goToNextDay())">
                    <ion-icon name="arrow-forward"></ion-icon>
                </ion-button>
            </div>
        </ion-card>

        <!-- Botones fijos en la parte inferior -->
        <div class="buttons-container">
            <ion-button (click)="finalizeDay()" [disabled]="!isDayComplete()"
                [color]="isDayComplete() ? 'primary' : 'medium'">
                Finalize Day</ion-button>
        </div>
    </div>

    <!-- Modal para añadir/editar comidas -->
    <ion-modal #mealModal [isOpen]="isModalOpen" (didDismiss)="onModalDismiss($event)">
        <ng-template>
            <ion-header>
                <ion-toolbar>
                    <ion-title>{{ currentMeal.name ? 'Edit Meal' : 'Add Meal' }}</ion-title>
                </ion-toolbar>
            </ion-header>

            <ion-content class="modal-container">


                <ion-input class="name" label="Name" placeholder="Enter meal name" labelPlacement="floating"
                    fill="outline" required [(ngModel)]="currentMeal.name" (ionInput)="filterSuggestions()">
                </ion-input>


                <!-- Lista de sugerencias -->
                <ion-list lines="none" *ngIf="suggestions.length > 0" class="suggestion-list">
                    <ion-item button *ngFor="let suggestion of suggestions" (click)="selectSuggestion(suggestion)">
                        {{ suggestion.name }}
                    </ion-item>
                </ion-list>

                <ion-item class="score" lines="none">
                    <ion-label>Score</ion-label>
                    <ion-range aria-label="Score" min="1" max="5" step="1" snaps="true" ticks="true"
                        [(ngModel)]="currentMeal.score"
                        [ngStyle]="{'--knob-background': getColorByScore(currentMeal.score)}">
                    </ion-range>
                </ion-item>

                <ion-item class="alarm" lines="none">
                    <ion-label>Defrosted Alarm?</ion-label>
                    <ng-container *ngIf="!currentMeal.alarmTime; else alarmSet">
                        <!-- Al activar el toggle, se abre el modal -->
                        <ion-toggle aria-label="Delivery Toggle" slot="end" [(ngModel)]="currentMeal.reminder"
                            (ionChange)="openTimePicker()"></ion-toggle>
                    </ng-container>
                    <ng-template #alarmSet>
                        <!-- Si ya hay alarma, se muestra un botón con la hora -->
                        <ion-button fill="outline" slot="end" (click)="openTimePicker()">
                            {{ currentMeal.alarmTime | date:'HH:mm' }}
                        </ion-button>
                        <ion-button fill="clear" color="danger" (click)="removeAlarm()">
                            <ion-icon name="trash"></ion-icon>
                        </ion-button>
                    </ng-template>
                </ion-item>

                <!-- Modal para seleccionar la hora -->
                <ion-modal [isOpen]="isTimePickerOpen" (didDismiss)="onTimePickerDismiss()">
                    <ng-template>
                        <ion-header>
                            <ion-toolbar>
                                <ion-title>Set the time</ion-title>
                                <ion-buttons slot="end">
                                    <ion-button (click)="cancelTimePicker()">Cancel</ion-button>
                                    <ion-button (click)="confirmTimePicker()">OK</ion-button>
                                </ion-buttons>
                            </ion-toolbar>
                        </ion-header>
                        <ion-content>
                            <ion-datetime class="timePickerModal" name="timePicker" presentation="time"
                                displayFormat="HH:mm" pickerFormat="HH:mm" [(ngModel)]="selectedTime">
                            </ion-datetime>

                        </ion-content>
                    </ng-template>
                </ion-modal>


                <ion-item class="delivery" lines="none">
                    <ion-label>Delivery?</ion-label>
                    <ion-toggle aria-label="Delivery Toggle" slot="end" [(ngModel)]="currentMeal.delivery">
                    </ion-toggle>
                </ion-item>

                <ion-button class="savebutton" (click)="saveMeal()"
                    [disabled]="!currentMeal.name || !currentMeal.score">
                    SAVE
                </ion-button>
            </ion-content>
        </ng-template>
    </ion-modal>
</ion-content>